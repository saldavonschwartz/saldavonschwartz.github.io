---
layout: post
title: Warp Fun
description: Applications of planar homographies
<!-- image: assets/images/pic05.jpg -->
---
<!-- Links: -->
[l1]: https://en.wikipedia.org/wiki/The_7th_Guest
[l3]: https://www.geometrictools.com/Documentation/MovingAlongCurveSpecifiedSpeed.pdf
[l4]: http://www.nouveaucinema.ca/en

- **[About](#1)**
- **[Finding a Homography between Corresponding Points in two Images](#2)**
- **[Warping Images](#3)**
- **[Application: Fake Billboards](#4)**
- **[Application: Panoramas](#5)**
- **[Application: Image Recognition](#6)**

### <a class="toc_item" name="1"></a>About:

Given a set of coplanar points in world space and their projection onto two different 2D image planes (i.e.: as seen by two different cameras or from two different points of view), a 2D planar **homograhpy** is a mapping between these two images of the same points. This mapping is useful in a variety of vision and computational photography tasks involving planes, such as image recognition, image stitching (i.e.: panoramas) and image rectification.

**[Figure 1. The homography drawing]**

In this project I implemented a general approach to finding homographies between sets of corresponding points in images as well as a few applications of the resulting homographies.

### <a class="toc_item" name="2"></a>Finding a Homography between Corresponding Points in two Images:

From Figure 1 and assuming we have two images (a source $$\mathbf{S}$$ and a target $$\mathbf{T}$$) which depict the same world-space coplanar points from different points of view, we wish to find a homography $$\mathbf{H} \in \mathbb{R}^{3 \times 3}$$ such that we can reproject these points (pixel coordinates) in $$\mathbf{S}$$ to their counterparts in $$\mathbf{T}$$.

Additionally, since the homography operates on projective space:
* Source points need to be converted from euclidean to projective space before multiplying them by $$\mathbf{H}$$.
* The resulting target points need to be converted from projective to euclidean space in order to obtain their final 2D coordinates.

So we want $$\mathbf{H}$$ such that given source pixel locations $$\mathbf{s}^{(i)}$$ and target pixel locations $$\mathbf{t}^{(i)}$$:

$$\bar{\mathbf{t}}^{(i)} = \mathbf{H} \hat{\mathbf{s}}^{(i)}\text{, where:}\\
\hat{\mathbf{s}}^{(i)} = \begin{bmatrix}s_x\\s_y\\1\end{bmatrix},\ \bar{\mathbf{t}}^{(i)} = \begin{bmatrix}\bar{t_x}\\\bar{t_y}\\\bar{t_w}\end{bmatrix},\ \mathbf{t}^{(i)} = \begin{bmatrix}\frac{\bar{t_x}}{\bar{t_w}}\\\frac{\bar{t_y}}{\bar{t_w}}\end{bmatrix}$$

Which can be expressed as a system of linear equations $$\mathbf{A}\mathbf{h} = \mathbf{b}$$. In this system $$\mathbf{h} \in \mathbb{R}^9$$ is the flattened homography matrix and $$\mathbf{A} \in \mathbb{R}^{n \times 9}: n >= 9$$ represents x and y-constraints (one per pixel coordinate; at least 4 pixel coordinates) plus a constant scale constraint which makes the system inhomogeneous and solvable via linear least squares.

The constraints are as follow:

* **x:** $$t_x\bar{t_w} - \bar{t_x} = 0 \Rightarrow\\
\begin{align}&t_x(h_{31}s_x + h_{32}s_y + h_{33}) - h_{11}s_x - h_{12}s_y - h_{13} = 0\\
&\begin{bmatrix}-s_x&-s_y&-1&0&0&0&t_x s_x&t_x s_y&t_x\end{bmatrix}^T\\
&{\mathbf{a}_x^{(i)}}^T \mathbf{h} = 0
\end{align}$$

* **y:** $$t_y\bar{t_w} - \bar{t_y} = 0 \Rightarrow\\
\begin{align}&t_y(h_{31}s_x + h_{32}s_y + h_{33}) - h_{21}s_x - h_{22}s_y - h_{23} = 0\\
&\begin{bmatrix}0&0&0&-s_x&-s_y&-1&t_y s_x&t_y s_y&t_y\end{bmatrix}^T\\
&{\mathbf{a}_y^{(i)}}^T \mathbf{h} = 0
\end{align}$$

* **scale:** $$\lVert\mathbf{H}\rVert_F = 1 \Rightarrow\\
\begin{align}
&\begin{bmatrix}0&0&0&0&0&0&0&0&1\end{bmatrix}^T\\
&\mathbf{a}_k^T \mathbf{h} = 1
\end{align}$$


From these constraints the system can be put together as:

$$\begin{bmatrix}{\mathbf{a}_x^{(1)}}^T\\{\mathbf{a}_y^{(1)}}^T\\\vdots\\{\mathbf{a}_x^{(4)}}^T\\{\mathbf{a}_y^{(4)}}^T\\\vdots\\{\mathbf{a}_x^{(n-1)}}^T\\{\mathbf{a}_y^{(n-1)}}^T\\\mathbf{a}_k^T\end{bmatrix} \begin{bmatrix}h_{11}\\h_{12}\\h_{13}\\h_{21}\\h_{22}\\h_{23}\\h_{31}\\h_{32}\\h_{33}\end{bmatrix} = \begin{bmatrix}0\\\vdots\\1\end{bmatrix}$$


And the solution to $$\text{min}_\mathbf{h}\ \lVert\mathbf{A}\mathbf{h} - \mathbf{b}\rVert^2_2 = (\mathbf{A}^T \mathbf{A})^{-1} \mathbf{A}^T \mathbf{b}$$ will be $$\mathbf{H}$$. Also, since 2D planar homographies are invertible, we have $$\mathbf{H}_{S2T}^{-1} = \mathbf{H}_{T2S}$$ which means that having computed the homography in one direction, we can invert it to reproject in the other direction.


### <a class="toc_item" name="3"></a>Warping Images:

Once a homography between source and target coordinates is computed, the whole source image can be warped by reprojecting all its pixel coordinates onto the target image's space. This is referred to as **forward** warping.

One issue with forward warping is that integer pixel coordinates in the source will likely map to subpixel coordinates in the target, requiring some interpolation scheme to figure out the values of a number of neighboring target pixels for the result to look acceptable. The alternative, known as **inverse** warping, instead uses the inverse of $$\mathbf{H}_{S2T} = \mathbf{H}_{T2S}$$ so that the problem is reformulated as:

$$
\begin{align}
\text{for}\ &\text{each pixel location}\ \mathbf{t}^{(i)} \in \mathbf{T}:\\
&\hat{\mathbf{t}}^{(i)} = \mathbb{R}2\mathbb{P}(\mathbf{t}^{(i)})\\
&\bar{\mathbf{s}}^{(i)} = \mathbf{H}_{T2S} \hat{\mathbf{t}}^{(i)}\\
&\mathbf{s}^{(i)} = \mathbb{P}2\mathbb{R}(\bar{\mathbf{s}}^{(i)})\\
&\mathbf{T}[\mathbf{t}^{(i)}] = \text{interpolate}(\mathbf{S}, \mathbf{s}^{(i)})
\end{align}
$$

Which is easier to approach since it requires computing a single interpolated value given a subpixel lookup in the source. The applications in this project use inverse warping with bilinear interpolation other than to figure out the sizes of final images.

### <a class="toc_item" name="4"></a>Application: Fake Billboards:

This application reprojects a frontal image $$\mathbf{S}$$ onto several locations in an image $$\mathbf{T}$$, as if $$\mathbf{S}$$

### <a class="toc_item" name="5"></a>Application: Panoramas:
TODO
### <a class="toc_item" name="6"></a>Application: Image Recognition:
TODO
